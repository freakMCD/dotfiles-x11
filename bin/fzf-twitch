#!/usr/bin/env python
# List specified twitch live channels with fzf
import subprocess
import os, signal
import requests
import json
import re
from pathlib import Path

player = "streamlink"
streams = f"""bitnerlp
insym
emilyywang
bebe872
"""
sep = " | "

headers = {
    "Authorization": "Bearer ei1608vl3nduyv668yylo2sw7b0bj1",
    "Client-Id": "khw0yso1ww3ca5hxyhsy1ye47kujx8"
}

def live(channel):
    info = requests.get(f"https://api.twitch.tv/helix/streams?user_login={channel}",headers=headers).json()
    info = info["data"][0]
    return f'{info["user_name"]}{sep}{info["game_name"]}{sep}{info["title"][:50]}'

def main():
    p = Path('.cache/streams.txt')
    live_streams = []
    with p.open("w",encoding="utf-8") as f:
        for stream in streams.splitlines():
            if stream == "":
                pass
            if 'isLiveBroadcast' in requests.get("https://www.twitch.tv/"+stream).content.decode('utf-8'): 
                live_streams.append(live(stream))
        if live_streams == []:
            live_streams.append("No live streams right now.")
        f.write('\n'.join(live_streams))
    choice=subprocess.check_output(f"cat {p}| fzf", shell=True)
    choice=choice.decode('utf-8')
    subprocess.Popen([f"{player}","--title","{author} - {category} - {title}", f"https://twitch.tv/{choice.split(sep)[0]}"], start_new_session=True)
    os.kill(os.getppid(), signal.SIGHUP)

if __name__ == "__main__":
    main()
